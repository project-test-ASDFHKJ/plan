name: Cross-Repo Issue Automation

on:
  issues:
    types: [edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process (leave empty to process all)'
        required: false

jobs:
  sync-child-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process Cross-Repo Child Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const helper = require('./.github/scripts/cross-repo-helper.js');

            // Configuration
            const PROJECT_NAME = 'EngageMe';  // Change this to your project name
            const DELAY_MS = 500;  // Delay between operations to avoid rate limiting

            // Get the issue to process
            let issue;
            if (context.eventName === 'workflow_dispatch') {
              const issueNumber = context.payload.inputs.issue_number;
              if (issueNumber) {
                issue = await helper.getIssue(
                  github,
                  context.repo.owner,
                  context.repo.repo,
                  parseInt(issueNumber)
                );
              } else {
                console.log('No issue number provided for manual run');
                return;
              }
            } else {
              issue = context.payload.issue;
            }

            console.log(`Processing issue #${issue.number}: ${issue.title}`);

            // Check if this issue has child issues
            if (!issue.sub_issues_summary || !issue.sub_issues_summary.sub_issues) {
              console.log('No child issues found');
              return;
            }

            const childIssues = issue.sub_issues_summary.sub_issues;
            console.log(`Found ${childIssues.length} child issue(s)`);

            // Find the project
            const project = await helper.findProject(github, context.repo.owner, PROJECT_NAME);
            if (!project) {
              console.error(`Project "${PROJECT_NAME}" not found`);
              return;
            }
            console.log(`Found project: ${project.title} (${project.id})`);

            // Get project fields
            const projectFields = await helper.getProjectFields(github, project.id);
            const typeField = helper.findField(projectFields, 'Type');
            const iterationField = helper.findField(projectFields, 'Iteration') ||
                                  helper.findField(projectFields, 'Sprint');

            // Get parent issue's project item to copy iteration
            let parentProjectItem = null;
            let parentIterationId = null;
            try {
              parentProjectItem = await helper.findProjectItem(github, project.id, issue.node_id);
              if (parentProjectItem && iterationField) {
                const parentFields = await helper.getProjectItemFields(github, project.id, parentProjectItem.id);
                const iterationValue = parentFields.find(f =>
                  f.field && f.field.name === iterationField.name
                );
                if (iterationValue && iterationValue.iterationId) {
                  parentIterationId = iterationValue.iterationId;
                  console.log(`Parent has iteration: ${iterationValue.title}`);
                }
              }
            } catch (error) {
              console.log('Could not get parent project item:', error.message);
            }

            // Track processed issues for summary
            const results = {
              processed: [],
              skipped: [],
              errors: []
            };

            // Process each child issue
            for (const child of childIssues) {
              await helper.delay(DELAY_MS);

              const childRef = helper.parseIssueUrl(child.url);
              if (!childRef) {
                console.log(`Could not parse URL: ${child.url}`);
                results.errors.push({ url: child.url, error: 'Invalid URL' });
                continue;
              }

              // Skip if same repo (handled by existing workflows)
              if (helper.isSameRepo(childRef, context.repo.owner, context.repo.repo)) {
                console.log(`Skipping same-repo issue #${childRef.number}`);
                results.skipped.push({
                  issue: `#${childRef.number}`,
                  reason: 'Same repository - handled by existing workflows'
                });
                continue;
              }

              console.log(`\n--- Processing ${childRef.owner}/${childRef.repo}#${childRef.number} ---`);

              try {
                // Get child issue details
                const childIssue = await helper.getIssue(
                  github,
                  childRef.owner,
                  childRef.repo,
                  childRef.number
                );

                const actions = [];

                // 1. Add to project and set Type field
                let childProjectItem = await helper.findProjectItem(github, project.id, childIssue.node_id);

                if (!childProjectItem) {
                  console.log('Adding issue to project...');
                  const itemId = await helper.addIssueToProject(github, project.id, childIssue.node_id);
                  childProjectItem = { id: itemId };
                  actions.push('Added to project');
                  await helper.delay(DELAY_MS);
                } else {
                  console.log('Issue already in project');
                }

                // 2. Set Type field based on title
                if (typeField) {
                  const issueType = helper.getIssueTypeFromTitle(childIssue.title);
                  if (issueType) {
                    const typeOption = typeField.options.find(o => o.name === issueType);
                    if (typeOption) {
                      await helper.updateSingleSelectField(
                        github,
                        project.id,
                        childProjectItem.id,
                        typeField.id,
                        typeOption.id
                      );
                      actions.push(`Set Type to "${issueType}"`);
                      await helper.delay(DELAY_MS);
                    }
                  }
                }

                // 3. Copy iteration from parent
                if (iterationField && parentIterationId) {
                  await helper.updateIterationField(
                    github,
                    project.id,
                    childProjectItem.id,
                    iterationField.id,
                    parentIterationId
                  );
                  actions.push('Copied iteration from parent');
                  await helper.delay(DELAY_MS);
                }

                // 4. Copy milestone from parent
                if (issue.milestone && !childIssue.milestone) {
                  await helper.copyMilestone(
                    github,
                    childRef.owner,
                    childRef.repo,
                    childRef.number,
                    issue.milestone
                  );
                  actions.push(`Set milestone to "${issue.milestone.title}"`);
                  await helper.delay(DELAY_MS);
                }

                // 5. Copy inheritable labels
                if (issue.labels && issue.labels.length > 0) {
                  const labelsToCopy = helper.filterInheritableLabels(issue.labels);
                  if (labelsToCopy.length > 0) {
                    await helper.copyLabels(
                      github,
                      childRef.owner,
                      childRef.repo,
                      childRef.number,
                      labelsToCopy
                    );
                    actions.push(`Added labels: ${labelsToCopy.join(', ')}`);
                    await helper.delay(DELAY_MS);
                  }
                }

                // 6. Add comment to child issue
                const commentBody = `üîó **Automated Setup Complete**

This issue has been linked as a child of ${context.repo.owner}/${context.repo.repo}#${issue.number} and automatically configured:

${actions.map(a => `- ‚úÖ ${a}`).join('\n')}

---
*Managed by [Cross-Repo Automation](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/.github/workflows/cross-repo-automation.yml)*`;

                await helper.addComment(
                  github,
                  childRef.owner,
                  childRef.repo,
                  childRef.number,
                  commentBody
                );

                results.processed.push({
                  issue: `${childRef.owner}/${childRef.repo}#${childRef.number}`,
                  title: childIssue.title,
                  actions
                });

                console.log(`‚úÖ Successfully processed ${childRef.owner}/${childRef.repo}#${childRef.number}`);

              } catch (error) {
                console.error(`‚ùå Error processing ${childRef.owner}/${childRef.repo}#${childRef.number}:`, error.message);
                results.errors.push({
                  issue: `${childRef.owner}/${childRef.repo}#${childRef.number}`,
                  error: error.message
                });
              }
            }

            // Post summary comment on parent issue
            if (results.processed.length > 0 || results.errors.length > 0) {
              let summary = `## ü§ñ Cross-Repo Automation Summary\n\n`;

              if (results.processed.length > 0) {
                summary += `### ‚úÖ Processed Issues (${results.processed.length})\n\n`;
                for (const item of results.processed) {
                  summary += `**${item.issue}** - ${item.title}\n`;
                  summary += `${item.actions.map(a => `  - ${a}`).join('\n')}\n\n`;
                }
              }

              if (results.skipped.length > 0) {
                summary += `### ‚è≠Ô∏è Skipped Issues (${results.skipped.length})\n\n`;
                for (const item of results.skipped) {
                  summary += `- ${item.issue}: ${item.reason}\n`;
                }
                summary += '\n';
              }

              if (results.errors.length > 0) {
                summary += `### ‚ùå Errors (${results.errors.length})\n\n`;
                for (const item of results.errors) {
                  summary += `- ${item.issue}: ${item.error}\n`;
                }
                summary += '\n';
              }

              summary += `---\n*Generated by [Cross-Repo Automation](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/.github/workflows/cross-repo-automation.yml)*`;

              await helper.addComment(
                github,
                context.repo.owner,
                context.repo.repo,
                issue.number,
                summary
              );
            }

            console.log('\n=== Summary ===');
            console.log(`Processed: ${results.processed.length}`);
            console.log(`Skipped: ${results.skipped.length}`);
            console.log(`Errors: ${results.errors.length}`);
