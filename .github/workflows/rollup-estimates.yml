name: Rollup Estimates and Remaining Work

# This workflow rolls up estimate and remaining work values from children to parents
#
# CROSS-REPOSITORY SUPPORT:
# - Child issues: Fully supported (can be in any repository within the organization)
# - Parent issues: Assumed to be in the same repository as the workflow trigger
#   (findParentIssue does not yet return repository information)
#
# When a child issue in a different repository is processed, its estimates
# are correctly fetched and included in the parent's rollup calculation.

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Task/Story number that was updated (triggers bottom-up rollup to parents)'
        required: true
        type: number
  issues:
    types: [edited, labeled]

env:
  # Configuration - Update these for your environment
  PROJECT_NAME: '[TEMPLATE] EngageMe'
  FIELD_ESTIMATE: 'Estimate'
  FIELD_REMAINING: 'Remaining'

jobs:
  rollup-to-parents:
    # Only run if manually triggered OR if 'sync' label was added
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'sync')
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent workflows from hanging indefinitely
    permissions:
      issues: write
      contents: read
      repository-projects: write
      # Note: GITHUB_TOKEN cannot access organization-level projects
      # Organization projects require elevated permissions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Rollup Estimates to Parent Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            console.log('üîÑ Rollup workflow triggered');
            console.log('=====================================');

            // Determine issue number based on trigger type
            let issueNumber;
            if (context.eventName === 'workflow_dispatch') {
              // Manual trigger
              issueNumber = parseInt(context.payload.inputs.issue_number);
              console.log(`üìã Manual trigger for issue #${issueNumber}`);
            } else if (context.eventName === 'issues') {
              // Issue event trigger
              issueNumber = context.issue.number;
              console.log(`üìã Issue event trigger for issue #${issueNumber}`);
            } else {
              console.log('‚ùå Unknown trigger type');
              return;
            }

            // Check if triggered by sync label
            if (context.eventName === 'issues' && context.payload.action === 'labeled') {
              if (context.payload.label.name !== 'sync') {
                console.log(`‚è≠Ô∏è  Skipping - label "${context.payload.label.name}" is not "sync"`);
                return;
              }
              console.log('‚úÖ Triggered by "sync" label');
            }


            // Schedule label removal at start (runs async, happens after 5 seconds)
            const removeLabelPromise = (async () => {
              if (context.eventName === 'issues' && context.payload.action === 'labeled' && context.payload.label.name === 'sync') {
                // Wait to ensure workflow has time to process
                await new Promise(r => setTimeout(r, 5000));
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: 'sync'
                  });
                  console.log('‚úÖ Removed "sync" label - workflow can be re-triggered');
                } catch (error) {
                  console.log('‚ÑπÔ∏è  Could not remove sync label:', error.message);
                }
              }
            })();

            // Get issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const issueBody = issue.data.body || '';

            // Helper function to find parent by querying the project's parent field
            async function findParentIssue(issueNum) {
              console.log(`üîç Looking for parent of issue #${issueNum} via project fields...`);

              try {
                // Query the project to find this issue and its parent field
                // Note: "Parent issue" in GitHub Projects UI uses the tracked issues relationship,
                // not a separate field. We need to query the issue's relationship data.
                const projectQuery = `
                  query($owner: String!) {
                    organization(login: $owner) {
                      projectsV2(first: 10) {
                        nodes {
                          id
                          title
                          items(first: 100) {
                            nodes {
                              id
                              content {
                                ... on Issue {
                                  number
                                  title
                                  repository {
                                    name
                                    owner { login }
                                  }
                                }
                              }
                              fieldValues(first: 20) {
                                nodes {
                                  ... on ProjectV2ItemFieldSingleSelectValue {
                                    name
                                    field {
                                      ... on ProjectV2SingleSelectField {
                                        name
                                      }
                                    }
                                  }
                                  ... on ProjectV2ItemFieldTextValue {
                                    text
                                    field {
                                      ... on ProjectV2Field {
                                        name
                                      }
                                    }
                                  }
                                  ... on ProjectV2ItemFieldNumberValue {
                                    number
                                    field {
                                      ... on ProjectV2Field {
                                        name
                                      }
                                    }
                                  }
                                  ... on ProjectV2ItemFieldDateValue {
                                    date
                                    field {
                                      ... on ProjectV2Field {
                                        name
                                      }
                                    }
                                  }
                                  ... on ProjectV2ItemFieldIterationValue {
                                    title
                                    field {
                                      ... on ProjectV2IterationField {
                                        name
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;

                console.log(`Querying project for issue #${issueNum}...`);
                console.log(`Organization owner: ${context.repo.owner}`);
                console.log(`Repository: ${context.repo.owner}/${context.repo.repo}`);

                const result = await github.graphql(projectQuery, {
                  owner: context.repo.owner
                });

                const projects = result.organization.projectsV2.nodes;
                console.log(`Found ${projects.length} project(s) in organization:`);
                projects.forEach((p, idx) => {
                  console.log(`  ${idx + 1}. "${p.title}" (ID: ${p.id})`);
                });

                const targetProject = projects.find(p => p.title === '[TEMPLATE] EngageMe');

                if (!targetProject) {
                  console.log(`\n‚ùå Project '[TEMPLATE] EngageMe' not found`);
                  console.log(`Looking for exact match: "[TEMPLATE] EngageMe"`);
                  console.log(`\nPlease update the PROJECT_NAME in the workflow file if the name is different.`);
                  return null;
                }

                console.log(`Found project: ${targetProject.title}`);

                // Find the item for this issue
                const item = targetProject.items.nodes.find(i =>
                  i.content && i.content.number === issueNum &&
                  i.content.repository.name === context.repo.repo &&
                  i.content.repository.owner.login === context.repo.owner
                );

                if (!item) {
                  console.log(`‚ùå Issue #${issueNum} not found in project`);
                  return null;
                }

                console.log(`Found issue #${issueNum} in project: ${item.content.title}`);
                console.log(`Issue has ${item.fieldValues.nodes.length} field values`);

                // Debug: Print ALL fields to see what's available
                console.log(`\nDEBUG: All field values for #${issueNum}:`);
                for (const fieldValue of item.fieldValues.nodes) {
                  if (!fieldValue.field) {
                    console.log(`  - (field without name)`);
                    continue;
                  }

                  const fieldName = fieldValue.field.name;
                  let value = 'unknown type';

                  if (fieldValue.text) value = `text: "${fieldValue.text}"`;
                  else if (fieldValue.number !== undefined) value = `number: ${fieldValue.number}`;
                  else if (fieldValue.name) value = `select: "${fieldValue.name}"`;
                  else if (fieldValue.date) value = `date: ${fieldValue.date}`;
                  else if (fieldValue.title) value = `iteration: "${fieldValue.title}"`;

                  console.log(`  - ${fieldName}: ${value}`);
                }
                console.log(``);

                // The "Parent issue" shown in GitHub UI uses trackedInIssues relationship, not a project field
                // Since we confirmed trackedInIssues returns 0, the relationship isn't properly set
                console.log(`‚ùå IMPORTANT: "Parent issue" in GitHub's UI is NOT stored as a project field.`);
                console.log(`   It uses GitHub's tracked issues relationship (trackedInIssues API).`);
                console.log(`   Our earlier check confirmed this returns 0 results for #${issueNum}.`);
                console.log(``);
                console.log(`   TO FIX: You need to properly create the parent-child relationship:`);
                console.log(`   1. Go to issue #75 (the parent)`);
                console.log(`   2. Look for "Sub-issues" section or click "..." menu`);
                console.log(`   3. Click "Add sub-issue" or "Convert to sub-issue"`);
                console.log(`   4. Select #76, #77 as sub-issues`);
                console.log(`   5. This will register the relationship in GitHub's API`);
                console.log(``);

                return null;

              } catch (error) {
                console.error(`‚ùå Error finding parent: ${error.message}`);
                console.error(`Error type: ${error.constructor.name}`);
                if (error.errors) {
                  console.error(`GraphQL errors:`, JSON.stringify(error.errors, null, 2));
                }
                console.error(`Stack: ${error.stack}`);
                return null;
              }
            }

            // Helper function to find children using GitHub's tracked issues API
            async function findChildIssues(parentNum) {
              console.log(`üîç Finding children of issue #${parentNum} via trackedIssues API...`);

              try {
                const graphqlQuery = `
                  query($owner: String!, $repo: String!, $parentNumber: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $parentNumber) {
                        trackedIssues(first: 100) {
                          totalCount
                          nodes {
                            number
                            title
                            state
                            repository {
                              name
                              owner {
                                login
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;

                const result = await github.graphql(graphqlQuery, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  parentNumber: parentNum
                });

                const trackedIssues = result.repository.issue.trackedIssues;
                const allChildren = trackedIssues.nodes;
                const openChildren = allChildren.filter(c => c.state === 'OPEN');

                console.log(`trackedIssues.totalCount: ${trackedIssues.totalCount}`);
                console.log(`Open children: ${openChildren.length} / ${allChildren.length}`);

                if (openChildren.length > 0) {
                  const childLabels = openChildren.map(c => {
                    if (c.repository.name !== context.repo.repo) {
                      return `${c.repository.name}#${c.number}`;
                    }
                    return `#${c.number}`;
                  }).join(', ');
                  console.log(`‚úÖ Found children: ${childLabels}`);
                } else if (allChildren.length > 0) {
                  console.log(`‚ö†Ô∏è  All ${allChildren.length} children are CLOSED`);
                } else {
                  console.log(`No children found - trackedIssues is empty`);
                  console.log(`This means #${parentNum} has no sub-issues registered in GitHub's API`);
                }

                return openChildren;

              } catch (error) {
                console.error(`‚ùå Error finding children: ${error.message}`);
                console.error(`Stack: ${error.stack}`);
                return [];
              }
            }

            console.log(`üìå Processing: #${issueNumber} - ${issue.data.title}`);
            console.log(`üìä Workflow: CHILD ‚Üí PARENT rollup (bottom-up)`);
            console.log('=====================================\n');

            // Find parent issue
            const parentIssueNumber = await findParentIssue(issueNumber);

            if (!parentIssueNumber) {
              console.log('No parent issue reference found');
              console.log('This issue is either:');
              console.log('  - A top-level Epic (no parent needed)');
              console.log('  - Missing a parent reference');
              return;
            }

            // Function to get all project fields for an issue (supports cross-repo)
            async function getProjectFields(issueNumber, owner = context.repo.owner, repo = context.repo.repo) {
              // Validate issue exists in specified repository
              try {
                const issue = await github.rest.issues.get({
                  owner: owner,
                  repo: repo,
                  issue_number: issueNumber
                });
              } catch (error) {
                console.log(`‚ö†Ô∏è  Issue ${owner}/${repo}#${issueNumber} not found: ${error.message}`);
                return null;
              }

              // Get all projects and their items (organization-level projects)
              const projectQuery = `
                query($owner: String!) {
                  organization(login: $owner) {
                    projectsV2(first: 10) {
                      nodes {
                        id
                        title
                        items(first: 100) {
                          nodes {
                            id
                            content {
                              ... on Issue {
                                id
                                number
                                repository {
                                  name
                                  owner {
                                    login
                                  }
                                }
                              }
                            }
                            fieldValues(first: 20) {
                              nodes {
                                ... on ProjectV2ItemFieldNumberValue {
                                  number
                                  field {
                                    ... on ProjectV2Field {
                                      id
                                      name
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                        fields(first: 20) {
                          nodes {
                            ... on ProjectV2Field {
                              id
                              name
                              dataType
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, {
                owner: context.repo.owner  // Organization owner, not issue owner
              });

              const projects = projectResult.organization.projectsV2.nodes;

              // Find the specific project "[TEMPLATE] EngageMe"
              const project = projects.find(p => p.title === '[TEMPLATE] EngageMe');

              if (!project) {
                console.log(`‚ö†Ô∏è  Issue ${owner}/${repo}#${issueNumber} - [TEMPLATE] EngageMe project not found`);
                return null;
              }

              // Find the item for this issue (match by number AND repository for cross-repo support)
              const item = project.items.nodes.find(i => {
                if (!i.content || i.content.number !== issueNumber) return false;

                // For cross-repo support, also match repository
                const itemOwner = i.content.repository?.owner?.login || context.repo.owner;
                const itemRepo = i.content.repository?.name || context.repo.repo;

                return itemOwner === owner && itemRepo === repo;
              });

              if (item) {
                const fields = {};
                item.fieldValues.nodes.forEach(fv => {
                  if (fv.field && fv.number !== undefined) {
                    fields[fv.field.name] = {
                      value: fv.number,
                      fieldId: fv.field.id
                    };
                  }
                });

                return {
                  projectId: project.id,
                  itemId: item.id,
                  fields: fields,
                  allFields: project.fields.nodes
                };
              }

              console.log(`‚ö†Ô∏è  Issue ${owner}/${repo}#${issueNumber} not found in project items`);
              return null;
            }

            // Function to update project field
            async function updateProjectField(projectId, itemId, fieldId, value) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: Float!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      number: $value
                    }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: projectId,
                itemId: itemId,
                fieldId: fieldId,
                value: value
              });
            }

            // Function to find all children and sum their estimates and remaining work
            async function calculateChildrenSums(parentNumber) {
              const children = await findChildIssues(parentNumber);
              console.log(`Found ${children.length} child issue(s)`);

              let totalEstimate = 0;
              let totalRemaining = 0;
              const childDetails = [];

              for (const child of children) {
                // Extract repository info for cross-repo support
                const childOwner = child.repository?.owner?.login || context.repo.owner;
                const childRepo = child.repository?.name || context.repo.repo;
                const childNumber = child.number;
                const repoLabel = childRepo !== context.repo.repo ? `${childRepo}#${childNumber}` : `#${childNumber}`;

                // Fetch project fields with explicit owner/repo for cross-repo support
                const projectFields = await getProjectFields(childNumber, childOwner, childRepo);

                if (projectFields && projectFields.fields) {
                  const estimate = projectFields.fields['Estimate']?.value || 0;
                  const remaining = projectFields.fields['Remaining']?.value || 0;

                  totalEstimate += estimate;
                  totalRemaining += remaining;

                  childDetails.push({
                    number: childNumber,
                    repo: childRepo,
                    estimate: estimate,
                    remaining: remaining
                  });

                  console.log(`  ${repoLabel}: Estimate=${estimate}, Remaining=${remaining}`);
                }
              }

              return {
                totalEstimate,
                totalRemaining,
                childCount: children.length,
                childDetails
              };
            }

            // Function to recursively update parent chain
            async function updateParentChain(parentNumber, depth = 0) {
              const indent = '  '.repeat(depth);
              console.log(`${indent}üìä Updating parent #${parentNumber}...`);

              // Check if parent issue exists
              try {
                await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentNumber
                });
              } catch (error) {
                console.error(`${indent}‚ùå Parent issue #${parentNumber} not found (404)`);
                return;
              }

              // Calculate sums from all children
              const sums = await calculateChildrenSums(parentNumber);

              console.log(`${indent}Total from ${sums.childCount} children: Estimate=${sums.totalEstimate}, Remaining=${sums.totalRemaining}`);

              // Get parent's project fields
              const parentProjectFields = await getProjectFields(parentNumber);

              if (!parentProjectFields) {
                console.log(`${indent}‚ö†Ô∏è  Parent #${parentNumber} not found in any project`);
                return;
              }

              // Find Estimate and Remaining field IDs
              const estimateField = parentProjectFields.allFields.find(f => f.name === 'Estimate');
              const remainingField = parentProjectFields.allFields.find(f => f.name === 'Remaining');

              if (!estimateField || !remainingField) {
                console.log(`${indent}‚ö†Ô∏è  Estimate or Remaining fields not found in project`);
                return;
              }

              // Update parent's fields
              try {
                await updateProjectField(
                  parentProjectFields.projectId,
                  parentProjectFields.itemId,
                  estimateField.id,
                  sums.totalEstimate
                );
                console.log(`${indent}‚úÖ Updated Estimate to ${sums.totalEstimate}`);

                await updateProjectField(
                  parentProjectFields.projectId,
                  parentProjectFields.itemId,
                  remainingField.id,
                  sums.totalRemaining
                );
                console.log(`${indent}‚úÖ Updated Remaining to ${sums.totalRemaining}`);


              } catch (error) {
                console.error(`${indent}Error updating parent:`, error.message);
                return;
              }

              // Find grandparent and continue chain
              const grandparentNumber = await findParentIssue(parentNumber);

              if (grandparentNumber) {
                console.log(`${indent}Found grandparent #${grandparentNumber}, continuing chain...`);
                await updateParentChain(grandparentNumber, depth + 1);
              } else {
                console.log(`${indent}No grandparent found, rollup complete`);
              }
            }

            // Start the rollup chain
            await updateParentChain(parentIssueNumber);

            console.log('‚úÖ Rollup complete!');

