name: Debug GitHub App Permissions

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Debug App Permissions
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            console.log('üîç GITHUB APP PERMISSIONS DEBUG\n');
            console.log('='.repeat(60));

            // Check what the token can see
            console.log(`\nüìã Context Information:`);
            console.log(`   Repository: ${context.repo.owner}/${context.repo.repo}`);
            console.log(`   Event: ${context.eventName}`);

            // Try to get repository info
            console.log(`\nüì¶ Repository Access Check:`);
            try {
              const repo = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log(`   ‚úÖ Can access repository: ${repo.data.full_name}`);
            } catch (error) {
              console.log(`   ‚ùå Cannot access repository: ${error.message}`);
            }

            // Try to query organization
            console.log(`\nüè¢ Organization Access Check:`);
            try {
              const org = await github.rest.orgs.get({
                org: context.repo.owner
              });
              console.log(`   ‚úÖ Can access organization: ${org.data.login}`);
              console.log(`   Organization name: ${org.data.name || 'N/A'}`);
            } catch (error) {
              console.log(`   ‚ùå Cannot access organization: ${error.message}`);
            }

            // Try repository-level projects
            console.log(`\nüìä Repository Projects (GraphQL):`);
            try {
              const repoProjectQuery = `
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    projectsV2(first: 10) {
                      totalCount
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              const repoResult = await github.graphql(repoProjectQuery, {
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const projects = repoResult.repository.projectsV2;
              console.log(`   Total repository projects: ${projects.totalCount}`);
              if (projects.nodes.length > 0) {
                projects.nodes.forEach((p, idx) => {
                  console.log(`   ${idx + 1}. #${p.number} - "${p.title}"`);
                });
              } else {
                console.log(`   (No repository-level projects found)`);
              }
            } catch (error) {
              console.log(`   ‚ùå Error querying repository projects: ${error.message}`);
              if (error.errors) {
                error.errors.forEach(e => {
                  console.log(`      - ${e.message}`);
                });
              }
            }

            // Try organization-level projects
            console.log(`\nüè¢ Organization Projects (GraphQL):`);
            try {
              const orgProjectQuery = `
                query($owner: String!) {
                  organization(login: $owner) {
                    projectsV2(first: 10) {
                      totalCount
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              const orgResult = await github.graphql(orgProjectQuery, {
                owner: context.repo.owner
              });
              const projects = orgResult.organization.projectsV2;
              console.log(`   Total organization projects: ${projects.totalCount}`);
              if (projects.nodes.length > 0) {
                projects.nodes.forEach((p, idx) => {
                  console.log(`   ${idx + 1}. #${p.number} - "${p.title}"`);
                });
              } else {
                console.log(`   (No organization-level projects found)`);
              }
            } catch (error) {
              console.log(`   ‚ùå Error querying organization projects: ${error.message}`);
              if (error.errors) {
                error.errors.forEach(e => {
                  console.log(`      - ${e.message}`);
                });
              }
            }

            // Try user-level projects (in case it's a personal account)
            console.log(`\nüë§ User Projects (GraphQL):`);
            try {
              const userProjectQuery = `
                query($login: String!) {
                  user(login: $login) {
                    projectsV2(first: 10) {
                      totalCount
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              const userResult = await github.graphql(userProjectQuery, {
                login: context.repo.owner
              });
              const projects = userResult.user.projectsV2;
              console.log(`   Total user projects: ${projects.totalCount}`);
              if (projects.nodes.length > 0) {
                projects.nodes.forEach((p, idx) => {
                  console.log(`   ${idx + 1}. #${p.number} - "${p.title}"`);
                });
              } else {
                console.log(`   (No user-level projects found)`);
              }
            } catch (error) {
              console.log(`   ‚ùå Error querying user projects: ${error.message}`);
              if (error.errors) {
                error.errors.forEach(e => {
                  console.log(`      - ${e.message}`);
                });
              }
            }

            // Try REST API for projects (legacy)
            console.log(`\nüìã Projects via REST API:`);
            try {
              const projects = await github.rest.projects.listForOrg({
                org: context.repo.owner
              });
              console.log(`   Found ${projects.data.length} classic projects`);
              if (projects.data.length > 0) {
                projects.data.forEach((p, idx) => {
                  console.log(`   ${idx + 1}. "${p.name}"`);
                });
              }
            } catch (error) {
              console.log(`   ‚ùå Error listing classic projects: ${error.message}`);
            }

            console.log(`\n${'='.repeat(60)}`);
            console.log('‚úÖ Debug complete\n');
